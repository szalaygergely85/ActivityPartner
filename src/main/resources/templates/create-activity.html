<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
    <title>Create Activity - Vivento</title>
    <link rel="icon" type="image/svg+xml" href="/images/vivento.svg"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200..800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link href="/css/app.css" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0d7ff2",
                        "danger": "#ef4444",
                        "warning": "#f59e0b",
                        "success": "#22c55e",
                        "background-dark": "#0a0f14",
                        "surface-dark": "#131b24",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "2xl": "2rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        .pb-safe { padding-bottom: max(100px, calc(80px + env(safe-area-inset-bottom))); }
    </style>
</head>
<body class="bg-gradient-custom text-white min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-background-dark/95 backdrop-blur-lg border-b border-white/5">
        <div class="flex items-center justify-between px-4 py-3 max-w-2xl mx-auto">
            <button onclick="history.back()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined text-2xl text-white">arrow_back</span>
            </button>
            <h1 class="text-lg font-bold text-white">Create Activity</h1>
            <div class="w-10"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-2xl mx-auto px-4 pb-safe">
        <!-- Hero Card -->
        <div class="mt-4 rounded-2xl overflow-hidden bg-primary">
            <img src="https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=600&h=200&fit=crop" alt="" class="w-full h-40 object-cover"/>
            <div class="p-4">
                <h2 class="text-lg font-bold text-white">Let's get people together!</h2>
                <p class="text-white/80 text-sm mt-1">Fill in the details below to host your event and build community.</p>
            </div>
        </div>

        <form id="create-form" class="mt-6 space-y-8">
            <!-- Basic Information -->
            <section>
                <h3 class="text-lg font-bold text-white mb-4">Basic Information</h3>

                <!-- Title -->
                <div class="mb-4">
                    <label for="title" class="block text-sm font-medium text-white mb-2">Activity Title</label>
                    <div class="relative">
                        <input
                            type="text"
                            id="title"
                            name="title"
                            placeholder="Name your activity"
                            required
                            maxlength="100"
                            class="w-full bg-surface-dark border border-slate-700 rounded-xl py-3.5 px-4 text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                        />
                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-primary text-xl">edit</span>
                    </div>
                </div>

                <!-- Category -->
                <div class="mb-4">
                    <label for="category" class="block text-sm font-medium text-white mb-2">Category</label>
                    <div class="relative">
                        <select
                            id="category"
                            name="category"
                            required
                            class="w-full bg-surface-dark border border-slate-700 rounded-xl py-3.5 px-4 text-white focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all appearance-none cursor-pointer"
                        >
                            <option value="" disabled selected>Select a category</option>
                            <option value="Sports">Sports</option>
                            <option value="Music">Music</option>
                            <option value="Art">Art</option>
                            <option value="Social">Social</option>
                            <option value="Outdoor">Outdoor</option>
                            <option value="Food">Food & Drink</option>
                            <option value="Gaming">Gaming</option>
                            <option value="Technology">Technology</option>
                            <option value="Education">Education</option>
                            <option value="Fitness">Fitness</option>
                            <option value="Other">Other</option>
                        </select>
                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-primary text-xl pointer-events-none">expand_more</span>
                    </div>
                </div>

                <!-- Cover Image -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-white mb-2">Cover Image (Optional)</label>
                    <div
                        id="cover-image-container"
                        class="relative h-36 rounded-2xl border-2 border-dashed border-slate-700 bg-surface-dark flex items-center justify-center cursor-pointer hover:border-primary/50 hover:bg-white/5 transition-all overflow-hidden"
                    >
                        <div id="cover-placeholder" class="text-center">
                            <span class="material-symbols-outlined text-4xl text-slate-500">add_photo_alternate</span>
                            <p class="text-slate-400 text-sm mt-2">Tap to select cover image</p>
                        </div>
                        <img id="cover-preview" src="" alt="" class="hidden absolute inset-0 w-full h-full object-cover"/>
                        <button type="button" id="remove-cover" class="hidden absolute top-2 right-2 w-8 h-8 bg-danger/90 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-white text-lg">close</span>
                        </button>
                    </div>
                    <input type="file" id="cover-input" accept="image/*" class="hidden"/>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-white mb-2">Description</label>
                    <div class="relative">
                        <textarea
                            id="description"
                            name="description"
                            placeholder="What will we do? Describe the vibe and any requirements."
                            rows="4"
                            maxlength="500"
                            class="w-full bg-surface-dark border border-slate-700 rounded-xl py-3.5 px-4 text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none"
                        ></textarea>
                        <span id="desc-counter" class="absolute bottom-3 right-3 text-xs text-slate-500">0/500</span>
                    </div>
                </div>
            </section>

            <!-- When & Where -->
            <section>
                <h3 class="text-lg font-bold text-white mb-4">When & Where</h3>

                <!-- Date & Time Row -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <!-- Date -->
                    <div>
                        <label for="date" class="block text-sm font-medium text-white mb-2">Date</label>
                        <div class="relative">
                            <input
                                type="date"
                                id="date"
                                name="date"
                                required
                                class="w-full bg-surface-dark border border-slate-700 rounded-xl py-3.5 px-4 text-white focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                            />
                        </div>
                    </div>

                    <!-- Time -->
                    <div>
                        <label for="time" class="block text-sm font-medium text-white mb-2">Time</label>
                        <div class="relative">
                            <input
                                type="time"
                                id="time"
                                name="time"
                                required
                                class="w-full bg-surface-dark border border-slate-700 rounded-xl py-3.5 px-4 text-white focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                            />
                        </div>
                    </div>
                </div>

                <!-- Location -->
                <div>
                    <label for="location" class="block text-sm font-medium text-white mb-2">Location</label>
                    <div class="relative">
                        <input
                            type="text"
                            id="location"
                            name="location"
                            placeholder="Search address or venue"
                            required
                            class="w-full bg-surface-dark border border-slate-700 rounded-xl py-3.5 px-4 pr-12 text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                        />
                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-primary text-xl">location_on</span>
                    </div>
                    <p class="text-slate-500 text-xs mt-2">Enter the full address or name of the venue</p>
                </div>
            </section>

            <!-- Capacity -->
            <section>
                <h3 class="text-lg font-bold text-white mb-4">Capacity</h3>

                <div>
                    <label for="spots" class="block text-sm font-medium text-white mb-2">Total Spots Available</label>
                    <div class="relative w-48">
                        <input
                            type="number"
                            id="spots"
                            name="spots"
                            placeholder="Unlimited"
                            min="1"
                            max="1000"
                            class="w-full bg-surface-dark border border-slate-700 rounded-xl py-3.5 px-4 pr-12 text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                        />
                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-primary text-xl">group</span>
                    </div>
                    <p class="text-slate-500 text-xs mt-2">Leave empty for unlimited spots</p>
                </div>
            </section>

            <!-- Error Message -->
            <div id="error-message" class="hidden text-danger text-sm py-3 px-4 bg-danger/10 rounded-xl"></div>
        </form>
    </main>

    <!-- Fixed Bottom Button -->
    <div class="fixed bottom-0 left-0 right-0 bg-background-dark/95 backdrop-blur-lg border-t border-white/10 p-4 z-40" style="padding-bottom: max(16px, env(safe-area-inset-bottom));">
        <div class="max-w-2xl mx-auto">
            <button
                type="submit"
                form="create-form"
                id="submit-btn"
                class="glow-button w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-xl text-base transition-all active:scale-[0.99] flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
            >
                <span id="btn-icon" class="material-symbols-outlined text-xl">check_circle</span>
                <span id="btn-text">Save Activity</span>
                <span id="btn-spinner" class="hidden">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
        </div>
    </div>

    <script>
        // Auth check
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        if (!getCookie('userId') && !getCookie('authToken')) {
            window.location.href = '/login';
        }

        // Set min date to today
        const dateInput = document.getElementById('date');
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;

        // Description counter
        const descInput = document.getElementById('description');
        const descCounter = document.getElementById('desc-counter');
        descInput.addEventListener('input', () => {
            descCounter.textContent = `${descInput.value.length}/500`;
        });

        // Cover image
        const coverContainer = document.getElementById('cover-image-container');
        const coverInput = document.getElementById('cover-input');
        const coverPreview = document.getElementById('cover-preview');
        const coverPlaceholder = document.getElementById('cover-placeholder');
        const removeCoverBtn = document.getElementById('remove-cover');
        let coverImageFile = null;

        coverContainer.addEventListener('click', (e) => {
            if (e.target !== removeCoverBtn && !removeCoverBtn.contains(e.target)) {
                coverInput.click();
            }
        });

        coverInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                coverImageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    coverPreview.src = e.target.result;
                    coverPreview.classList.remove('hidden');
                    coverPlaceholder.classList.add('hidden');
                    removeCoverBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        removeCoverBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            coverImageFile = null;
            coverInput.value = '';
            coverPreview.src = '';
            coverPreview.classList.add('hidden');
            coverPlaceholder.classList.remove('hidden');
            removeCoverBtn.classList.add('hidden');
        });

        // Form submission
        const form = document.getElementById('create-form');
        const submitBtn = document.getElementById('submit-btn');
        const btnIcon = document.getElementById('btn-icon');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const errorMessage = document.getElementById('error-message');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Disable button and show loading
            submitBtn.disabled = true;
            btnIcon.classList.add('hidden');
            btnText.textContent = 'Creating...';
            btnSpinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            try {
                // Upload cover image first if selected
                let coverImageUrl = null;
                if (coverImageFile) {
                    const formData = new FormData();
                    formData.append('file', coverImageFile);
                    const uploadRes = await fetch('/api/activities/upload-image', {
                        method: 'POST',
                        body: formData
                    });
                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        coverImageUrl = uploadData.url || uploadData.imageUrl;
                    }
                }

                // Build activity data
                const activityData = {
                    title: document.getElementById('title').value.trim(),
                    category: document.getElementById('category').value,
                    description: document.getElementById('description').value.trim(),
                    activityDate: document.getElementById('date').value + 'T' + document.getElementById('time').value + ':00',
                    location: document.getElementById('location').value.trim(),
                };

                const spots = document.getElementById('spots').value;
                if (spots) {
                    activityData.maxParticipants = parseInt(spots);
                }

                if (coverImageUrl) {
                    activityData.coverImageUrl = coverImageUrl;
                }

                // Create activity
                const response = await fetch('/api/activities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(activityData)
                });

                if (response.ok) {
                    const activity = await response.json();
                    // Redirect to the activity page or home
                    window.location.href = activity.id ? `/activity/${activity.id}` : '/';
                } else {
                    const data = await response.json();
                    throw new Error(data.message || data.error || 'Failed to create activity');
                }
            } catch (error) {
                errorMessage.textContent = error.message || 'Something went wrong. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                btnIcon.classList.remove('hidden');
                btnText.textContent = 'Save Activity';
                btnSpinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
